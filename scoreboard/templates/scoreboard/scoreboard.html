{% extends "base.html" %}
{% load static %}

{% block css_files %}
    <link rel="stylesheet" href="{% static "scoreboard/scoreboard.css" %}">
{% endblock css_files %}

{% block page_title %}جدول امتیازات{% endblock page_title %}

{% block page_content %}

<div id="scoreboard-page-container" class='container-fluid mt-5 text-center'>
    <h2 class='mb-4'>جدول امتیازات</h2>

    <div id='scoreboard-container'
        hx-get="{% url 'scoreboard:scoreboard_data' %}"
        hx-trigger="load, every 10s"
        hx-swap="innerHTML"
        data-anim-duration="2000"      
        data-anim-ease="cubic-bezier(.22,.61,.36,1)"
        data-anim-stagger="true" >

    <div class="loading-placeholder">در حال بارگذاری…</div>
  </div>

  
     <div class="text-center mb-5">
    <a href="{% url 'core:home' %}" class="btn btn-secondary btn-lg">بازگشت</a>
    </div>
</div>


{% endblock page_content %}

{% block page_scripts %}
<script>

  (function () {
    const CONTAINER_ID = 'scoreboard-container';
    let prevRects = {};

    const byKey = (root) => {
      const map = {};
      root.querySelectorAll('tbody tr.score-row[data-key]').forEach(tr => {
        map[tr.dataset.key] = tr.getBoundingClientRect();
      });
      return map;
    };

    const animate = (root, before, after) => {
      Object.keys(after).forEach(key => {
        if (!before[key]) return;          
        const dy = before[key].top - after[key].top;
        if (!dy) return;                  

        const row = root.querySelector(`tr.score-row[data-key="${key}"]`);
        if (!row) return;

        // Preparation stage
        row.style.willChange = 'transform';
        row.style.transition = 'none';
        row.style.transform = `translateY(${dy}px)`;

        row.getBoundingClientRect();

        // Run the animation
        row.style.transition = 'transform 400ms ease';
        row.style.transform = 'translateY(0)';

        row.addEventListener('transitionend', () => {
          row.style.transition = '';
          row.style.transform = '';
          row.style.willChange = '';
        }, { once: true });
      });
    };

    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById(CONTAINER_ID);
      if (!container || !window.htmx) return;

      // Initial snapshot (first page load)
      prevRects = byKey(container);

      // Before swap: take snapshot of current DOM
      document.body.addEventListener('htmx:beforeSwap', (e) => {
        const target = e.target; // عنصر هدف سواپ
        if (!target || target.id !== CONTAINER_ID) return;
        prevRects = byKey(target);
      });

      // After swap: new content loaded, get new positions and animate
      document.body.addEventListener('htmx:afterSwap', (e) => {
        const target = e.target;
        if (!target || target.id !== CONTAINER_ID) return;

        // Reflow کل tbody تا اندازه‌ها پایدار شوند
        const nextRects = byKey(target);
        animate(target, prevRects, nextRects);
        prevRects = nextRects; // For future updates
      });
    });
  })();
</script>
{% endblock page_scripts %}
