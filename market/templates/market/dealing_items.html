{% extends "base.html" %}
{% load static %}

{% block page_content %}
<div class="container mt-5 col-md-8">
  <h2 class="text-center mb-4">خرید و فروش کالا</h2><br>

  <form method="POST" id="dealForm">
    {% csrf_token %}
    <div class="row mb-3">
      <div class="col-md-4">
        <label>گروه:</label>
        <select name="team" id="teamSelect" class="form-select" required>
          <option value="">انتخاب گروه</option>
          {% for t in teams %}
            <option value="{{ t.id }}">{{ t.team_number }} - {{ t.group_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="teamInfo" class="alert alert-secondary" style="display:none;">
        <h6>کالاهای تیم:</h6>
        <div id="teamItems"></div>
      </div>


      <div class="col-md-4">
        <label>نوع عملیات:</label>
        <select name="operation" class="form-select" required>
          <option value="buying">خرید از بانک</option>
          <option value="selling">فروش به بانک</option>
        </select>
      </div>

      <div class="col-md-4">
        <label>روش پرداخت:</label>
        <select id="pay_method" name="pay_method" class="form-select" onchange="togglePaymentFields()">
          <option value="cash">نقدی</option>
          <option value="bank">حساب</option>
          <option value="mixed">ترکیبی</option>
        </select>
      </div>
    </div>

    <div id="cash_field" class="mb-3">
      <label>مبلغ نقدی:</label>
      <input type="number" name="cash_part" step="50" class="form-control" value="0">
    </div>

    <div id="bank_field" class="mb-3">
      <label>مبلغ بانکی:</label>
      <input type="number" name="bank_part" step="50" class="form-control" value="0">
    </div>

    <hr>
    <h5 class="text-center mb-3">لیست کالاها</h5>

    <table class="table table-striped table-bordered text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>نام کالا</th>
          <th>قیمت فعلی</th>
          <th>تعداد</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ item.name }}</td>
          <td>{{ item.current_price }}</td>
          <td>
            <input type="number" min="0" name="item_{{ item.id }}" class="form-control text-center" value="0">
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-center mt-3">
      <button type="submit" class="btn btn-primary btn-lg">ثبت عملیات</button>
    </div>
  </form>

  <div id="messageBox" class="mt-4 text-center fw-bold"></div>
  <a href="{% url 'bank:bank_home' %}" class="btn btn-secondary mt-3">بازگشت</a>
</div>
{% endblock %}

{% block page_scripts %}
<script>

function togglePaymentFields() {
  const method = document.getElementById('pay_method').value;
  document.getElementById('cash_field').style.display = (method === 'mixed') ? 'block' : 'none';
  document.getElementById('bank_field').style.display = (method === 'mixed') ? 'block' : 'none';
}
togglePaymentFields();

document.getElementById('teamSelect').addEventListener('change', function() {
  const teamId = this.value;
  const infoBox = document.getElementById('teamInfo');
  const itemList = document.getElementById('teamItems');

  // اگر تیمی انتخاب نشد، باکس بسته شود
  if (!teamId) {
    infoBox.style.display = 'none';
    itemList.innerHTML = '';
    return;
  }

  // درخواست به سرور برای گرفتن کالاهای تیم
  fetch(`/market/get_team_item_info/?team_id=${teamId}`)
    .then(res => res.json())
    .then(data => {
      itemList.innerHTML = ''; // پاک کردن لیست قبلی

      if (data.error) {
        infoBox.style.display = 'none';
        console.error(data.error);
        return;
      }

      // اگر تیم هیچ کالایی ندارد
      if (!data.items || data.items.length === 0) {
        itemList.innerHTML = '<em>هیچ کالایی برای این تیم ثبت نشده است.</em>';
      } else {
        // نمایش کالاها و تعدادشان
        data.items.forEach(obj => {
          const row = document.createElement('div');
          row.textContent = `کالا: ${obj.item} | تعداد: ${obj.quantity}`;
          itemList.appendChild(row);
        });
      }

      infoBox.style.display = 'block';
    })
    .catch(err => {
      console.error("خطا در گرفتن کالاهای تیم:", err);
      infoBox.style.display = 'none';
    });
});

document.getElementById('dealForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  const response = await fetch(form.action || window.location.pathname, {
    method: 'POST',
    body: formData,
    headers: {'X-Requested-With': 'XMLHttpRequest'},
  });

  const data = await response.json();
  const msgBox = document.getElementById('messageBox');
  msgBox.textContent = '';
  msgBox.className = 'mt-4 text-center fw-bold';

  if (data.error) {
    msgBox.classList.add('text-danger');
    msgBox.textContent = data.error;
  } else if (data.success) {
    msgBox.classList.add('text-success');
    msgBox.innerHTML = data.success.join('<br>');
    form.reset();
    togglePaymentFields();
  }

  setTimeout(() => msgBox.textContent = '', 4000);
});
</script>
{% endblock %}
